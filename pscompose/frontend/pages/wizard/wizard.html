<div id="wizard-container"></div>

<script id="wizard-step-template" type="nunjucks">
    <div class="wizard-page">
        <header class="wizard-header">
            <h3>{{ headerTitle }}</h3>
            <div class="progress-bar">
                <web-button
                    id="prev-btn"
                    link="{{ prevLink | default('/') }}"
                    label="{{ prevButton }}"
                    theme="Primary">
                </web-button>
                <progress-bar step="{{ step }}"></progress-bar>
                <web-button
                    id="next-btn"
                    link="{{ nextLink }}"
                    label="{{ nextButton }}"
                    theme="Tertiary"
                    righticon="arrow-right">
                </web-button>
            </div>
        </header>

        <div class="step-section">
            <h2>Step {{ step }}) {{ singular }}</h2>
            <p class="step-text">
                {{ stepText | safe }}
            </p>
            <div class="step-box">
                <div class="step-box-left">
                    <dropdown-single-select label="{{ singular }}"></dropdown-single-select>
                    <web-button
                        id="new-btn"
                        label="New {{ singular }}"
                        theme="Shadow"
                        lefticon="{{ leftIcon }}">
                    </web-button>
                </div>
                <div class="step-box-right">
                    <i style="color: var(--shadow-color); width: 150; height: 150"
                        data-lucide="{{ leftIcon }}">
                    </i>
                </div>
            </div>
        </div>   
        <div hx-get="/partials/confirm-modals.html" hx-trigger="load"></div>
    </div>
</script>

<script>
    (async function renderWizardStep() {
        const { activeRoute, metadata } = psCompose || {};
        const step = activeRoute?.step ?? 1;
        const meta = metadata?.wizard?.[step - 1];
        if (!meta) return console.error(`No metadata for step ${step}`);

        const totalSteps = metadata.wizard.length - 1;

        // Build desc
        const baseDesc = meta.desc || "";
        const learnMoreLink = meta.link
            ? `<a href="${meta.link}" target="_blank">Learn More</a>`
            : "";
        const stepInstruction =
            step < totalSteps
                ? `${baseDesc} ${learnMoreLink}<br/><br/>Use the <b>New ${meta.singular}</b> button to add new <b>${meta.plural}</b> as needed.`
                : baseDesc;

        // Build rendering context
        const context = {
            step,
            headerTitle: `New ${meta.singular}`,
            singular: meta.singular,
            plural: meta.plural,
            stepText: stepInstruction.trim(),
            leftIcon: meta.icon || "info",
            prevLink: step > 1 ? metadata.wizard[step - 2].page_url : "/",
            nextLink: step < totalSteps ? metadata.wizard[step]?.page_url : "",
            prevButton: step > 1 ? "Previous" : "Cancel",
            nextButton: step >= totalSteps ? "Save" : "Next",
        };

        // Render wizard template
        const template = document.getElementById("wizard-step-template").innerHTML;
        const container = document.getElementById("wizard-container");
        container.innerHTML = nunjucks.renderString(template, context);

        lucide.createIcons();
        htmx.process(container);

        // Render new template form
        if (step === totalSteps) {
            const stepBox = container.querySelector(".step-box");
            if (stepBox) {
                stepBox.classList.replace("step-box", "step-box-column");
                stepBox.innerHTML = `<div class="w-full" hx-get="/partials/data_new_form.html" hx-trigger="load"></div>`;
                htmx.process(stepBox);
                document.querySelector("#next-btn").setAttribute("type", "submit");
                document.querySelector("#next-btn").setAttribute("confirm-modal", "save-modal");
            }
            return;
        }

        await populateDropdown(activeRoute?.list_endpoint);
        setupEventListeners(meta.icon);

        var params = new URLSearchParams(window.location.search);
        if (params.get("id")) loadForm({id: params.get("id"), icon: meta.icon});
        if (params.get("new")) loadForm({ isNew: true, icon: meta.icon });
    })();

    async function populateDropdown(endpoint) {
        try {
            const response = await fetch(endpoint);
            if (!response.ok) throw new Error(`Failed to fetch data: ${response.statusText}`);

            const data = await response.json();
            const dataList = data.map((item) => ({
                const: item.id,
                title: item.name,
            }));
            document
                .querySelector("dropdown-single-select")
                .setAttribute("options", JSON.stringify(dataList));
        } catch (err) {
            console.error("Error:", err);
        }
    }

    const container = document.querySelector(".step-box-right");
    const dropdown = document.querySelector("dropdown-single-select");
    const newBtn = document.getElementById("new-btn");

    function setupEventListeners(defaultIcon = "info") {
        dropdown?.addEventListener("change", (evt) => loadForm({ id: evt.target.value, icon: defaultIcon}));
        newBtn?.addEventListener("click", () => loadForm({ isNew: true, icon: defaultIcon }));
    }

    function loadForm({ id = null, isNew = false,  icon="info" } = {}) {
        const url = new URL(window.location.href);
        url.search = "";

        if (isNew) {
            url.searchParams.set("new", "true");
            dropdown.value = '';
            container.innerHTML = `
                <div style='width: 100%' 
                    hx-get="/partials/data_new_form.html" 
                    hx-trigger="load">
                </div>`;
        } else if (id) {
            url.searchParams.set("id", id);
            psCompose.activeRoute.id = id;
            dropdown.value = id;
            container.innerHTML = `
                <div style='width: 100%'
                    hx-get="/partials/data_edit_form.html" 
                    hx-trigger="load">
                </div>`;
        } else {
            container.innerHTML = `<i style="color: var(--shadow-color); width: 150; height: 150" data-lucide='${defaultIcon}'></i>`;
        }

        window.history.pushState({}, "", url.toString());
        htmx.process(container);
        lucide.createIcons();
    }
</script>
