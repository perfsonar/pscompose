<div class="homepage" role="main" aria-label="pSCompose Homepage">
    <header role="banner" aria-labelledby="getting-started-heading">
        <h1 id="getting-started-heading">Getting Started</h1>
        <br />
        <p class="getting-started-p" id="welcome-text">
            Welcome to pSCompose!
            <br />
            Are you starting a template from scratch? Start by entering hosts.
            <br />
            Do you need to import an existing template?
        </p>
    </header>

    <ul class="getting-started-boxes" aria-label="Template creation options">
        <li class="list-box">
            <div class="box-header">
                <i
                    class="lucide"
                    style="color: var(--copy)"
                    data-lucide="locate"
                    aria-hidden="true"
                ></i>
                <h4 class="box-name">Import Template</h4>
                <ps-button
                    link="/import/"
                    theme="Icon-Success"
                    righticon="arrow-right"
                    aria-label="Import an existing template"
                ></ps-button>
            </div>
            <p class="box-text">
                Import an existing template json by uploading the file or copying and pasting the
                json directly. You can make edits as needed once imported
            </p>
        </li>

        <li class="list-box">
            <div class="box-header">
                <i class="lucide" data-lucide="plus" aria-hidden="true"></i>
                <h4 class="box-name">Create New Template</h4>
                <ps-button
                    link="wizard/1/address/"
                    theme="Icon-Success"
                    righticon="arrow-right"
                    aria-label="Create a new template from scratch"
                ></ps-button>
            </div>
            <p class="box-text">This will walk you through creating a new template from scratch</p>
        </li>
    </ul>

    <section class="published-templates" aria-labelledby="published-templates-heading">
        <h4 id="published-templates-heading">Published Templates</h4>
        <table aria-label="Published Templates Table">
            <thead>
                <tr>
                    <th scope="col">
                        <div class="th-content">
                            <i class="lucide" data-lucide="locate" aria-hidden="true"></i>
                            <span>Name</span>
                        </div>
                    </th>
                    <th scope="col">
                        <div class="th-content">
                            <i class="lucide" data-lucide="clipboard-list" aria-hidden="true"></i>
                            <span>Task(s)</span>
                        </div>
                    </th>
                    <th scope="col">
                        <div class="th-content">
                            <i class="lucide" data-lucide="file-edit" aria-hidden="true"></i>
                            <span>Action</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody nunjucks-array-template="published-templates-tbody"></tbody>
        </table>
    </section>
</div>

<script src="/partials/data_template_json.js"></script>
<script>
    async function loadPublishedTemplateTable() {
        const table = document.querySelector("tbody");

        try {
            const response = await fetch(psCompose.metadata["template"].list_endpoint);
            let templates_data = await response.json();

            await Promise.all(templates_data.map(async (template) => {
                template.formatted_date = formatDate(template.last_edited_at);
                template.editlink = psCompose.metadata["template"].page_url + '?id=' + template.id + '&edit=true';

                try {
                    template.tasks = [];
                    if (template.json.tasks && template.json.tasks.length > 0) {
                        const taskPromises = template.json.tasks.map(async (taskId) => {
                            try {
                                const taskResponse = await fetch(psCompose.metadata["task"].list_endpoint + taskId + '/');
                                return await taskResponse.json();
                            } catch (err) {
                                console.warn(`Failed to fetch task ${taskId}:`, err);
                                return null;
                            }
                        });
                        const tasks = await Promise.all(taskPromises);
                        template.tasks = tasks.filter(task => task !== null);
                    }
                } catch (err) {
                    console.warn(`Failed to fetch template JSON for ${template.id}:`, err);
                    template.tasks = [];
                }
            }));

            const templateStr  = `
                <tbody>
                    {% if templates_data and templates_data.length > 0 %}
                        {% for template in templates_data %}
                            <tr>
                                <td>
                                    <a class="td-content" href="/templates/?id={{template.id}}">
                                        {{template.name}}
                                    </a>
                                </td>
                                <td>
                                    <div class='td-content tags'>
                                    {% if template.tasks and template.tasks.length > 0 %}
                                        {% for task in template.tasks %}
                                            <a href="/task/?id={{task.id}}">
                                                <li class="tag" aria-labelledby="shortcut-{{ task.id }}">
                                                    {{ task.name }}
                                                </li>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <p>No tasks</p>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="td-content action-icons">
                                        <div class="action-icon">
                                            <div class="tooltip">Edit Template</div>
                                            <ps-button link="{{template.editlink}}" righticon="edit" theme="Icon" aria-hidden="true"></ps-button>
                                        </div>
                                        <div class="action-icon">
                                            <div class="tooltip">Download Template</div>
                                            <ps-button id="download-btn" data-id="{{template.id}}" data-name="{{template.name}}" righticon="download" theme="Icon"></ps-button>
                                        </div>
                                        <div class="action-icon">
                                            <div class="tooltip">Copy Template JSON to Clipboard</div>
                                            <ps-button id="copy-btn" data-id="{{template.id}}" righticon="clipboard-copy" theme="Icon"></ps-button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr> 
                            <td></td>
                            <td class="text-center"> <p> No published templates </p></td>
                            <td></td>
                        </tr>
                    {% endif %}
                </tbody>
            `;
            table.innerHTML = nunjucks.renderString(templateStr, { templates_data, psCompose });
            lucide.createIcons();

            table.querySelectorAll("#download-btn").forEach((btn) => {
                btn.addEventListener("click", async (event) => {
                    await exportTemplateJSON(event.currentTarget.dataset.id, event.currentTarget.dataset.name);
                });
            });

            table.querySelectorAll("#copy-btn").forEach((btn) => {
                btn.addEventListener("click", async (event) => {
                    await copyTemplateJSON(event.currentTarget.dataset.id);
                });
            });

        } catch (err) {
            console.error(`Error loading Published Templates:`, err);
            table.innerHTML = "<p role='alert'>Failed to load templates. Please try again later.</p>";
        }
    }
    loadPublishedTemplateTable();
</script>

