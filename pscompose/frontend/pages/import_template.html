<div class="w-full import-page">
    <h3>Import Template</h3>
    <div class="step-section">
        <p>To import template, please provide name and import via URL link or file upload.</p>
        <div class="step-box-column">
            <form id="template-import-form" method="GET">
                <fieldset id="content" hx-trigger="load" nunjucks-template="example-template">
                    <i class="spinner" data-lucide="loader-circle"></i>
                </fieldset>

                <script id="example-template" type="nunjucks">
                    <json-form
                      form-data='{{ form_data | dump }}'
                      schema-data='{{ json_schema | dump }}'
                      layout-data='{{ ui_schema | dump }}'
                      readonly='true'
                    ></json-form>
                </script>
                <div class="save-cancel">
                    <ps-button
                        id="save-btn"
                        type="submit"
                        label="Save"
                        theme="Secondary"
                        righticon="save"
                        confirm-modal="save-modal"
                    >
                    </ps-button>
                    <ps-button
                        type="button"
                        label="Cancel"
                        theme="Primary"
                        righticon="x"
                        link="javascript:history.back()"
                    >
                    </ps-button>
                </div>
            </form>
        </div>
    </div>
    <div hx-get="/partials/confirm-modals.html" hx-trigger="load"></div>
</div>

<script>
    document
        .getElementById("content")
        .setAttribute("hx-get", `${psCompose.activeRoute.list_endpoint}import/form/`);

    document.querySelector('#template-import-form').addEventListener("submit", (e) => {
        e.preventDefault();

        const elem = document.querySelector("json-form");
        const form_data = JSON.parse(elem.serializeForm());
        const isFormEmpty = Object.keys(form_data).length === 0;
        const isValid = elem.validate();
        console.log('isvalid: ', isValid, form_data);
        debugger;
        if ((!isValid || isFormEmpty)) {
            document
            .querySelectorAll(
                "ps-input-text, ps-textarea-json, ps-input-file, ps-select"
            )
            .forEach((control) => {
                control.markDirty();
                control.connectedCallback();
            });

            sessionStorage.setItem(
                "confirmMessage",
                JSON.stringify(["Form fields not all valid", "Error"]),
            );
            processLastMessage();
        } else {
            document.dispatchEvent(new Event("validated"));
            document
                .querySelector("#save-modal")
                .addEventListener("confirm-yes-clicked", async function (event) {
                    let jsonContent = null;

                    if (form_data['importVia'] == 'upload') {
                        const file = document.querySelector('ps-input-file').files[0];
                        if (!file) return;
                        jsonContent = JSON.parse(await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const text = e.target.result;
                                try {
                                    JSON.parse(text);  // Validate JSON
                                    resolve(text);
                                } catch (err) {
                                    alert('The file does not contain valid JSON.');
                                    resolve(null);
                                }
                            };
                            reader.onerror = () => resolve(null);
                            reader.readAsText(file);
                        }));
                    }
                    else if (form_data['importVia'] == 'url') {
                        const url = form_data['url']
                        if (!url) return;
                        try  {
                            const response = await fetch(url);
                            jsonContent= JSON.parse(await response.json());
                        } catch (error) {
                            console.error('Failed to fetch JSON:', error);
                        }
                    }
                    else if (form_data['importVia'] == 'paste') {
                        jsonContent = form_data['paste'];
                    }

                    if (!jsonContent) return;

                    // 1. Form body data to send to api
                    const data = {
                        ref_set: [],
                        type: 'psconfig',
                        json: jsonContent,
                        name: form_data['name'],
                        created_by: "ssbaveja", // TODO: this will not be needed since it'll be parsed from user object
                        last_edited_by: "ssbaveja", // TODO: this will not be needed since it'll be parsed from user object
                        // url: ""
                    };

                    const resolveConflict = form_data['resolveConflict'] || 'keep-same-name'

                    // 2. Post request to api
                    try {
                        const response = await fetch(`${psCompose.activeRoute.list_endpoint}`, {
                            method: "POST",
                            headers: { 
                                "Content-Type": "application/json",
                                "X-Import": "true",
                                "X-Conflict": JSON.stringify(resolveConflict)
                            },
                            body: JSON.stringify(data),
                        });

                        if (!response.ok) throw new Error(`HTTP error ${response.statusText}`);
                        const result = await response.json();
                        savemsg = psCompose.activeRoute.singular + " saved successfully!";
                        sessionStorage.setItem(
                            "confirmMessage",
                            JSON.stringify([savemsg, "Success"]),
                        );

                        // 3. Redirect

                        // 3.1 Saving favorites 
                        // if (document.querySelector("ps-ps-input-checkbox-star").value) {
                        //     try {
                        //         const response = await fetch(`${window.API_BASE_URL}/favorites/${'ssbaveja'}/${result.id}/`, {
                        //             method: "PUT",
                        //             headers: { 'Authorization': `Basic ${btoa('ssbaveja:password')}` },
                        //         });
                        //         if (!response.ok) throw new Error(`HTTP error ${response.statusText}`);
                        //     } catch (error) {
                        //         console.error('Failed to update favorites:', error);
                        //     }
                        // };

                        window.location = window.location.pathname+ "?id=" + result.id;
                    } catch (error) {
                        console.error("Error:", error);
                        sessionStorage.setItem(
                            "confirmMessage",
                            JSON.stringify(["Something went wrong.", "Error"]),
                        );
                        processLastMessage();
                    }
                });
        }
        
    });
    
    // Render Saved Template in Read Mode
    var params = new URLSearchParams(window.location.search);
    var id = params.get("id");
    if (id) {
        document.querySelector('h3').innerText = "Success! Your template has been saved.";
        document.querySelector(".step-box-column").innerHTML = `<div class="w-full" hx-get="/partials/data_read_form.html" hx-trigger="load"></div>`;
    }
</script>