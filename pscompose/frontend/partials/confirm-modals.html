<web-modal id="save-modal" theme="Success" question="Are you sure mate?" confirm-label="Save">
</web-modal>

<web-modal id="delete-modal" theme="Error" question="Are you sure mate?" confirm-label="Delete">
</web-modal>

<script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const dataType = psCompose.activeRoute.singular.toLowerCase();

    // INSERT api/find results
    function resultToHtml(result) {
        if (result.length === 0) return;
        return `
        <div class="confirm-message">
            <h5>Saving changes to this ${dataType} will impact the following:</h5>
            <ul>
                ${result
                    .map((item) => `<li>${capitalizeFirstLetter(item.type)} ${item.name}</li>`)
                    .join("")}
            </ul>
        </div>
        `;
    }

    (async () => {
        let result = [];
        try {
            const response = await fetch(`${window.API_BASE_URL}/${dataType}/${id}/find`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            });
            result = await response.json();
        } catch (error) {
            console.error("Error:", error);
        }
        deleteModal.setAttribute("message", resultToHtml(result));
    })();

    // Save Datatype
    const saveBtn = document.querySelector("#save-modal");
    const saveMsg = "Are you sure you want to save this " + dataType + " ?";
    saveBtn.setAttribute("question", saveMsg);

    // Delete Datatype
    const deleteModal = document.querySelector("#delete-modal");
    const deleteMsg = "Are you sure you want to delete this " + dataType + " ?";
    deleteModal.setAttribute("question", deleteMsg);

    deleteModal.addEventListener("confirm-yes-clicked", async function (event) {
        const deleteSuccessMsg = "Successfully deleted " + dataType + "!";
        const deleteFailMsg = "Something went wrong while deleting" + dataType + ".";

        try {
            const response = await fetch(`${window.API_BASE_URL}/${dataType}/${id}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            });
            sessionStorage.setItem(
                "confirmMessage",
                JSON.stringify(
                    response.ok ? [deleteSuccessMsg, "Success"] : [deleteFailMsg, "Error"],
                ),
            );
            window.location = psCompose.activeRoute.page_url;
        } catch (error) {
            console.error("Error:", error);
        }
    });

    function capitalizeFirstLetter(str) {
        if (!str) return str;
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
</script>
