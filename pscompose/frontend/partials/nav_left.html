<nav class="menu" aria-label="Menu Navigation">
    <div id="nav-container"></div>
    <script id="nav-template" type="nunjucks">
        <ul class="nav" role="menu" aria-label="Primary menu" aria-orientation="vertical">
            {% for key, item in psCompose.nav %}
            <li
                role="menuitem"
                class="parent-item nav-item"
                id="{{ key }}"
                data-subnav="{{ key }}"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="subnav-content-{{ key }}"
            >
                <i data-lucide="{{ item.icon }}" style="width: 2rem; height: 2rem" aria-hidden="true"></i>
                <p>{{ item.plural }}</p>
            </li>
            {% endfor %}
        </ul>   
    </script>
    <div class="subnav-container hidden"></div>
    <script id="subnav-template" type="nunjucks">
        <div class='subnav' id='subnav-content' role='region' aria-label='{{data.psCompose.nav[data.psCompose.activeMenuItem].plural}} subnav'>
            <div class="subnav-header">
                <h1>{{data.psCompose.nav[data.psCompose.activeMenuItem].plural}}</h1>
                <web-button
                    link="{{data.psCompose.nav[data.psCompose.activeMenuItem].page_url ~ 'new/'}}"
                    theme="AddBtn"
                    lefticon="plus"
                    label="New"
                    aria-labelledby="subnav-title"
                    >
                </web-button>
            </div>
            <input
                type="text"
                id="subnav-search"
                placeholder="Search {{data.psCompose.nav[data.psCompose.activeMenuItem].singular}}"
                aria-label="Search {{data.psCompose.nav[data.psCompose.activeMenuItem].singular}}"
            />
            <ul id="subnav-list" aria-label="subnav List">
                {% for item in data %}
                <li id="{{item.id}}" class="subnav-item">
                    <i data-lucide="{{data.psCompose.nav[data.psCompose.activeMenuItem].icon}}" aria-hidden="true"></i>
                    <h5>{{item.name}}</h5>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </script>
</nav>

<script>
    document.getElementById('nav-container').innerHTML = nunjucks.renderString(document.getElementById('nav-template').innerHTML, { psCompose });

    const menuContainer = document.querySelector(".nav");
    const subnavContainer = document.querySelector(".subnav-container");
    const parentMenuItems = document.querySelectorAll(".nav .parent-item");

    const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    // RENDER AND CLEAR ACTIVE CLASSES
    const clearActiveClasses = (selector) => {
        document.querySelectorAll(selector).forEach((el) => {
            el.setAttribute("aria-expanded", "false");
            el.classList.remove("active");
        });
    };

    function highlightActiveSubnav(activeId) {
        if (!activeId) return;
        clearActiveClasses(".subnav li.active");
        const activeElement = document.querySelector(`.subnav [id="${activeId}"]`);
        if (activeElement) activeElement.classList.add("active");
    }

    function renderHighlight() {
        clearActiveClasses(".nav .parent-item");
        const activeMenuItem = document.querySelector(`.nav #${psCompose.activeMenuItem}`);
        if (!activeMenuItem) return;
        activeMenuItem.classList.add("active");
        activeMenuItem.setAttribute("aria-expanded", "true");
        highlightActiveSubnav(psCompose.activeRoute?.id);
    }

    // LOAD SUBNAV PAGE
    function loadSubnavPage(url, id) {
        if (!url || !id) return;

        const newUrl = `${url}?id=${id}`;
        if (window.location.pathname !== url) {
            window.location = newUrl;
            return;
        }

        window.history.pushState({}, "", newUrl);
        psCompose.activeRoute.id = id;

        htmx.ajax("GET", psCompose.activeRoute.page_template, "#router-content");
        highlightActiveSubnav(id);
    }

    window.addEventListener("popstate", (event) => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (!id) return;

        psCompose.activeRoute.id = id;
        htmx.ajax("GET", psCompose.activeRoute.page_template, "#router-content");
        highlightActiveSubnav(id);
    });

    // SEARCH FILTERING
    function filtersubnavItems(searchValue) {
        const filter = searchValue.trim().toLowerCase();
        const items = document.querySelectorAll("#subnav-list li");

        items.forEach((li) => {
            const text = li.textContent.toLowerCase();
            li.style.display = text.includes(filter) ? "" : "none";
        });
    }

    subnavContainer.addEventListener("input", (e) => {
        if (e.target.id === "subnav-search") {
            filtersubnavItems(e.target.value);
        }
    });


    // SHOW/HIDE subnav
    async function showSubnav() {
        if (subnavContainer.classList.contains("open")) return;
        if (shortcutsContainer.classList.contains("open")) await hideShortcuts();

        subnavContainer.classList.remove("hidden");
        subnavContainer.offsetWidth; 
        subnavContainer.classList.remove("close");

        subnavContainer.innerHTML = `
          <div
            hx-get='${psCompose.nav[psCompose.activeMenuItem].list_endpoint}'
            hx-trigger='load'
            hx-target='.subnav-container'
            nunjucks-array-template="subnav-template"
            hx-context='${JSON.stringify({ psCompose })}'>
          </div>`;

        htmx.process(subnavContainer);
        renderHighlight();
        subnavContainer.classList.add("open");

        subnavContainer.addEventListener("click", (e) => {
            const li = e.target.closest("li.subnav-item");
            if (!li) return;
            const url = psCompose.nav[psCompose.activeMenuItem].page_url;
            loadSubnavPage(url, li.id);
        });
    }

    async function hideSubnav() {
        psCompose.activeMenuItem = null;
        if (subnavContainer.classList.contains("hidden")) return;

        clearActiveClasses(".nav .parent-item");
        subnavContainer.classList.remove("open");
        subnavContainer.classList.add("close");

        await wait(200);

        subnavContainer.classList.add("hidden");
        subnavContainer.classList.remove("close");
    }

    // ATTACH CLICK EVENT LISTENERS TO PARENT MENU ITEMS
    parentMenuItems.forEach((elem) => {
        elem.addEventListener("click", async () => {
            const clickedMenu = elem.dataset.subnav;
            const curActiveMenuItem = psCompose.activeMenuItem;

            await hideSubnav();

            if (curActiveMenuItem === clickedMenu) {
                if (window.location.pathname == "/") showShortcuts();
                return;
            }

            psCompose.activeMenuItem = clickedMenu;
            showSubnav();
        });
    });

    document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target.classList.contains("subnav-container") && psCompose.activeRoute?.id) {
            highlightActiveSubnav(psCompose.activeRoute.id);
        }
    });
</script>
