<nav class="menu" aria-label="Menu Navigation">
    <div id="nav-container"></div>
    <script id="nav-template" type="nunjucks">
        <ul class="nav" role="menu" aria-label="Primary menu" aria-orientation="vertical">
            {% for key, item in psCompose.nav %}
            <li
                role="menuitem"
                class="parent-item nav-item"
                id="{{ key }}"
                data-subnav="{{ key }}"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="subnav-content-{{ key }}"
            >
                <i id="nav-icon" data-lucide="{{ item.icon }}" style="width: 2rem; height: 2rem" aria-hidden="true"></i>
                <p>{{ item.plural }}</p>
            </li>
            {% endfor %}
        </ul>   
    </script>
    <div class="subnav-container hidden"></div>
    <script id="subnav-template" type="nunjucks">
        <div class='subnav' id='subnav-content' role='region' aria-label='{{data.psCompose.nav[data.psCompose.activeMenuItem].plural}} subnav'>
            <div class="subnav-header">
                <h1>{{data.psCompose.nav[data.psCompose.activeMenuItem].plural}}</h1>
                <ps-button
                    link="{{data.psCompose.nav[data.psCompose.activeMenuItem].page_url ~ 'new/'}}"
                    theme="AddBtn"
                    lefticon="plus"
                    label="New"
                    aria-labelledby="subnav-title"
                    >
                </ps-button>
            </div>
            <input
                type="text"
                id="subnav-search"
                placeholder="Search {{data.psCompose.nav[data.psCompose.activeMenuItem].singular}}"
                aria-label="Search {{data.psCompose.nav[data.psCompose.activeMenuItem].singular}}"
            />
            <ul id="subnav-list" aria-label="subnav List">
                {% for item in data %}
                    <li id="{{item.id}}" class="subnav-item">
                        <div class="item-info">
                            <ps-input-checkbox id="subnav-item-checkbox" theme="Small" style="display: none;"></ps-input-checkbox>
                            <i id="subnav-icon" data-lucide="{{data.psCompose.nav[data.psCompose.activeMenuItem].icon}}" aria-hidden="true"></i>
                            <h5>{{item.name}}</h5>
                        </div>
                        {% if item.id in data.favorites_data %}
                            <i data-lucide="star" class="favorite-star" aria-hidden="true"></i>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            <div class='select-btns'>
                <ps-button id="select-mode" label="Select" theme="Small"></ps-button>
                <ps-button class="delete-all-btn" label="Delete" theme="SmallError"></ps-button>
                <ps-button class="open-all-btn" label="Open" lefticon="external-link" theme="Small"></ps-button>
            </div>
        </div>
    </script>
</nav>

<script>
    document.getElementById('nav-container').innerHTML = nunjucks.renderString(document.getElementById('nav-template').innerHTML, { psCompose });

    const menuContainer = document.querySelector(".nav");
    const subnavContainer = document.querySelector(".subnav-container");
    const parentMenuItems = document.querySelectorAll(".nav .parent-item");

    const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    // RENDER AND CLEAR ACTIVE CLASSES
    const clearActiveClasses = (selector) => {
        document.querySelectorAll(selector).forEach((el) => {
            el.setAttribute("aria-expanded", "false");
            el.classList.remove("active");
        });
    };

    function highlightActiveSubnav(activeId) {
        if (!activeId) return;
        clearActiveClasses(".subnav li.active");
        const activeElement = document.querySelector(`.subnav [id="${activeId}"]`);
        if (activeElement) activeElement.classList.add("active");
    }

    function renderHighlight() {
        clearActiveClasses(".nav .parent-item");
        const activeMenuItem = document.querySelector(`.nav #${psCompose.activeMenuItem}`);
        if (!activeMenuItem) return;
        activeMenuItem.classList.add("active");
        activeMenuItem.setAttribute("aria-expanded", "true");
        highlightActiveSubnav(psCompose.activeRoute?.id);
    }

    // LOAD SUBNAV PAGE
    function loadSubnavPage(url, id) {
        if (!url || !id) return;

        const newUrl = `${url}?id=${id}`;
        if (window.location.pathname !== url) {
            window.location = newUrl;
            return;
        }

        window.history.pushState({}, "", newUrl);
        psCompose.activeRoute.id = id;

        htmx.ajax("GET", psCompose.activeRoute.page_template, "#router-content");
        highlightActiveSubnav(id);

        if ((window.innerWidth < 1025)) hideSubnav();
    }

    window.addEventListener("popstate", (event) => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        if (!id) return;

        psCompose.activeRoute.id = id;
        htmx.ajax("GET", psCompose.activeRoute.page_template, "#router-content");
        highlightActiveSubnav(id);
    });

    // SEARCH FILTERING
    function filtersubnavItems(searchValue) {
        const filter = searchValue.trim().toLowerCase();
        const items = document.querySelectorAll("#subnav-list li");

        items.forEach((li) => {
            const text = li.textContent.toLowerCase();
            li.style.display = text.includes(filter) ? "" : "none";
        });
    }

    subnavContainer.addEventListener("input", (e) => {
        if (e.target.id === "subnav-search") {
            filtersubnavItems(e.target.value);
        }
    });

    async function updateSubnav() {
        const favorites_data = await fetchFavoriteIDs();

        if (!psCompose.activeMenuItem) {
            psCompose.activeMenuItem = psCompose.activeRoute.key
        }

        const endpoint = favorites_data ? psCompose.nav[psCompose.activeMenuItem].list_endpoint + 'favorites/' + 'ssbaveja' : psCompose.nav[psCompose.activeMenuItem].list_endpoint;
        const context = { psCompose, favorites_data: favorites_data || [] };


        subnavContainer.innerHTML = `
          <div
            hx-get='${endpoint}'
            hx-trigger='load'
            hx-target='.subnav-container'
            hx-headers='{ "Authorization": "Basic ${btoa('ssbaveja:password')}" }'
            nunjucks-array-template="subnav-template"
            hx-context='${JSON.stringify(context)}'>
          </div>`;

        htmx.process(subnavContainer);
        renderHighlight();
    }


    // SHOW/HIDE subnav
    async function showSubnav() {
        if (subnavContainer.classList.contains("open")) return;
        if (shortcutsContainer.classList.contains("open")) await hideShortcuts();

        subnavContainer.classList.remove("hidden");
        subnavContainer.offsetWidth;
        subnavContainer.classList.remove("close");

        try {
            await updateSubnav()
        } catch (e) {
            console.error('Failed to load favorites:', e);
        }

        subnavContainer.classList.add("open");


        // Attach Event Listeners
        subnavContainer.addEventListener('htmx:load', function (e) {
            attachSubnavEventListeners()
        });
    }

    async function hideSubnav() {
        psCompose.activeMenuItem = null;
        if (subnavContainer.classList.contains("hidden")) return;

        clearActiveClasses(".nav .parent-item");
        subnavContainer.classList.remove("open");
        subnavContainer.classList.add("close");

        await wait(200);

        subnavContainer.classList.add("hidden");
        subnavContainer.classList.remove("close");
    }

    // ATTACH CLICK EVENT LISTENERS TO PARENT MENU ITEMS
    parentMenuItems.forEach((elem) => {
        elem.addEventListener("click", async () => {
            const clickedMenu = elem.dataset.subnav;
            const curActiveMenuItem = psCompose.activeMenuItem;

            await hideSubnav();

            if (curActiveMenuItem === clickedMenu) {
                if (window.location.pathname == "/") showShortcuts();
                return;
            }

            psCompose.activeMenuItem = clickedMenu;
            showSubnav();
        });
    });

    document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target.classList.contains("subnav-container") && psCompose.activeRoute?.id) {
            highlightActiveSubnav(psCompose.activeRoute.id);
        }
    });

    function attachSubnavEventListeners() {
        document.querySelectorAll('li.subnav-item').forEach((item) => {
            item.addEventListener('click', function (e) {
                if (document.getElementById('subnav-list').classList.contains('select')) {
                    const ul = document.querySelector('#subnav-list');
                    var selected = JSON.parse(ul.getAttribute('data-list'));
                    const cb = item.querySelector('ps-input-checkbox')

                    cb.value = !cb.value
                    if (cb.value && !selected.includes(item.id)) selected.push(item.id);
                    else selected.pop(item.id)

                    ul.setAttribute('data-list', JSON.stringify(selected));
                } else {
                    const url = psCompose.nav[psCompose.activeMenuItem].page_url;
                    loadSubnavPage(url, item.id);
                }
            });
        });
        document.getElementById('select-mode').addEventListener('click', handleSelectMode);
    }

    function handleSelectMode(e) {
        const btn = e.currentTarget;

        // change btn to x
        btn.label = ''
        btn.righticon = 'X'
        btn.id = 'select-cancel'
        btn.removeEventListener('click', handleSelectMode);
        btn.addEventListener('click', handleSelectCancel);

        // change mode by adding class descriptor
        document.getElementById('subnav-list').classList.add('select')

        // Add delete btn
        const deleteBtn = document.querySelector('.delete-all-btn');
        deleteBtn.classList.add('selecting')
        deleteBtn.addEventListener('click', handleDelete);

        // Add open tab btn
        const openAllBtn = document.querySelector('.open-all-btn');
        openAllBtn.classList.add('selecting')
        // openAllBtn.addEventListener('click', handleOpenAll)

        // Init Selected List
        document.querySelector('#subnav-list').setAttribute('data-list', JSON.stringify([])); // Init Empty List

        // Show all checkboxes
        subnavContainer.querySelectorAll('ps-input-checkbox').forEach((checkbox) => {
            checkbox.style.display = 'flex';
            checkbox.value = false;
        });
        subnavContainer.querySelectorAll('#subnav-icon').forEach((icon) => {
            icon.style.display = 'none'
        })
    }

    function handleSelectCancel(e) {
        const btn = e.currentTarget

        // change btn to select
        btn.label = 'Select';
        btn.righticon = '';
        btn.id = 'select-mode';
        btn.removeEventListener('click', handleSelectCancel);
        btn.addEventListener('click', handleSelectMode);

        // change mode by adding class descriptor
        document.getElementById('subnav-list').classList.remove('select')

        // Add delete btn
        const deleteBtn = document.querySelector('.delete-all-btn');
        deleteBtn.classList.remove('selecting')

        // Add open tab btn
        const openAllBtn = document.querySelector('.open-all-btn');
        openAllBtn.classList.remove('selecting')

        // Hide all checkboxes
        subnavContainer.querySelectorAll('ps-input-checkbox').forEach((checkbox) => {
            checkbox.style.display = 'none'
        });
        subnavContainer.querySelectorAll('#subnav-icon').forEach((icon) => {
            icon.style.display = 'flex'
        })
    };

    async function handleDelete(e) {
        const ul = document.querySelector('#subnav-list');
        const selected = JSON.parse(ul.getAttribute('data-list'));
        if (selected.length <= 0) return;
        
        let failedCount = 0;

        for (const id of selected) {
            try {
                const res = await fetch(
                `${psCompose.nav[psCompose.activeMenuItem].list_endpoint}${id}/`,
                {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                }
                );
                if (!res.ok) {
                failedCount++;
                }
            } catch (e) {
                failedCount++;
            }
        }

        if (failedCount > 0) {
            newMessageBanner(`${failedCount} items failed`, "Error", true);
        } else {
            newMessageBanner("All items deleted", "Success", true);
        }

        // Update Window Render
        var params = new URLSearchParams(window.location.search);
        var id = params.get("id");
        updateSubnav()
        if (selected.includes(id)) {
            window.location = psCompose.nav[psCompose.activeMenuItem].page_url;
        }
    }

    /* V1.1TODO: Open all button */
    // function handleOpenAll(e) {
    //     const ul = document.querySelector('#subnav-list');
    //     var selected = JSON.parse(ul.getAttribute('data-list'));

    //     if (selected.length <= 0) return
    //     console.log(selected, psCompose.nav[psCompose.activeMenuItem])
        
    //     selected.forEach((id, index) => {
    //         setTimeout(() => {
    //             window.open(`${psCompose.nav[psCompose.activeMenuItem].page_url}?id=${id}`, '_blank', 'noopener,noreferrer');
    //             window.focus();
    //         }, index * 100000);
    //     });

    // }


</script>