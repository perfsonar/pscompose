<div class="datatype edit-form" hx-ext="dynamic-url">
  <div class="page">
    <h2>Edit Group</h2>
    <div class="content">
      <form id="my-form">
        <fieldset
          id="content"
          hx-get="http://0.0.0.0:8000/api/group/{id}/form"
          hx-trigger="load"
          nunjucks-template="example-template"
        >
          Loading Form...
        </fieldset>

        <script src="/partials/customRenderer.js" type="module"></script>
        <script id="example-template" type="nunjucks">
          <json-form
            id="my-json-form"
            form-data='{{ form_data | dump }}'
            schema-data='{{ json_schema | dump }}'
            layout-data='{{ ui_schema | dump }}'
            readonly='true'
          ></json-form>
        </script>

        <div class="save-cancel">
          <web-button
            data-label="Delete"
            data-theme="error"
            data-righticon="trash-2"
            data-redirect="/groups/"
            hx-delete="http://0.0.0.0:8000/api/group/{id}"
            hx-confirm="Are you sure you want to delete this group?"
            >
          </web-button>

          <web-button
            data-label="Save"
            data-theme="Secondary"
            data-righticon='save'>
          </web-button>

          <web-button
            data-label="Cancel"
            data-theme="Primary"
            data-righticon='x'>
          </web-button>
        </div>
      </form>
      <!-- Response container -->
      <div id="response-container"></div>
    </div>
  </div>
</div>

<script>
  document.getElementById("my-form").addEventListener("submit", async function (event) {
    event.preventDefault(); // stop default form submission

    const elem = document.querySelector("json-form");
    const form_data = JSON.parse(elem.serializeForm())
    const { name, ...rest } = form_data; // Need to remove name from the form

    const now = new Date();

    // TODO: How would ref_set be updated?
    const updated_data = {
      json: rest,
      name: name,
      last_edited_at: now.toISOString(),
      last_edited_by: "ssbaveja", // TODO: this will not be needed since it'll be parsed from user object
    }

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    try {
      const response = await fetch(`http://0.0.0.0:8000/api/group/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(updated_data)
      });

      const result = await response.json();
      console.log("Success:", result);
      document.getElementById("response-container").innerText = "Group saved successfully!";
    } catch (error) {
      console.error("Error:", error);
      document.getElementById("response-container").innerText = "Something went wrong.";
    }
  });
</script>
